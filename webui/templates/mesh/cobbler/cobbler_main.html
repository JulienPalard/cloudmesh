{% extends "layout/layoutTable.html" %}
{% import "mesh/cobbler/cobbler_macro.html" as CMB %}
{% block contentbox %}
<h2> {{ CMB.CM_IMAGE_BUTTON(object_type) }} </h2>
{% endblock contentbox %}

{% block content %}

<script src="/static/js/accordion_plugin.js" type="text/javascript"></script>

<script type="text/javascript">
    var status_save_url = "/cobbler/savestatus";
    var status_object = { '{{object_type}}': {}};
    var bcreated_accordion = false;
    {% autoescape False %}
    var cobbler_update_fields = [{{js_vars["update"]|join(", ")}}];
    var cobbler_add_fields = [{{js_vars["add"]|join(", ")}}];
    {% endautoescape%}
    var cobbler_data = { '{{object_type}}': {}};
    var cobbler_url = "/cobbler/{{object_type}}";

    // callback func after a section clicked
    // param object_uid is the id of the h3 element in accordion
    function CallbackOnAccordionClicked(object_uid, status) {
        status_object['{{object_type}}'][object_uid] = status;
    };

    // callback func after accordion created
    function CallbackAfterAccordionCreated() {
        {% if result["result"] %}
            {% set datas = result["data"] %}
            {% for data in datas %}
                status_object['{{object_type}}']['{{data["name"]}}'] = false;
            {% endfor %}
            status_object['{{object_type}}']['add_{{object_type}}'] = false;
        {% endif %}
        bcreated_accordion = true;
    };

</script>

<script>
    $(document).ready( function() {
        CustomizeAccordionPlugin("#accordion", CallbackOnAccordionClicked, CallbackAfterAccordionCreated);
        PreventClickEventPropagate(".inner_function_button");
    });

    // fill cobbler data object with specified fields in the section (uid)
    function fill_cobbler_data(fields, uid, flag_not_add) {
        data = cobbler_data['{{object_type}}'];
        for(i = 0; i < fields.length; i++) {
            field = fields[i];
            field_uid = uid + "_" + field;
            data[field] = $("#" + field_uid).val();
        }
        if (typeof flag_not_add == "boolean" && flag_not_add) {
            data["name"] = uid;
        }
    }

    function clear_cobbler_data() {
        cobbler_data['{{object_type}}'] = {};
    }

    // callback func after refresh/reset one section
    function callback_get_cobbler(uid, data) {
        $get_h3 = $("#" + uid);
        $get_h3_div = $get_h3.next("div");
        $get_h3_div.remove();
        $get_h3.replaceWith(data["template"]);
        refresh_accordion();
    }

    // refresh icon on each section of accordion
    function refresh_cobbler(cobbler_types, uid) {
        reset_cobbler(cobbler_types, uid);
        PreventClickEventPropagate(".inner_function_button");
    }

    // reset button in each section of accordion
    function reset_cobbler(cobbler_types, uid) {
        url = cobbler_url + "/" + uid;
        send_ajax_request(uid, url, "get", callback_get_cobbler);
    }

    // callback func after update one section
    function callback_update_cobbler(uid, data) {
        // do nothing
    }

    // update button in each section of accordion
    function update_cobbler(cobbler_types, uid) {
        // get/fill data object with the value of update fields
        fill_cobbler_data(cobbler_update_fields, uid, true);
        url = cobbler_url + "/" + cobbler_data['{{object_type}}']['name'];
        send_ajax_request(uid, url, "put", callback_update_cobbler);
        // clear data after submit
        clear_cobbler_data();
    }

    // callback func after delete one section
    function callback_delete_cobbler(uid, data) {
        $delete_h3 = $("#" + uid);
        $delete_h3_div = $delete_h3.next("div");
        $delete_h3_div.remove();
        $delete_h3.remove();
        // remove status data of this section
        delete cobbler_data['{{object_type}}'][uid];
        delete status_object['{{object_type}}'][uid];
        //refresh_accordion();   // does not need refresh
    }

    // delete button in each section of accordion
    function delete_cobbler(cobbler_types, uid) {
        url = cobbler_url + "/" + uid;
        send_ajax_request(uid, url, "delete", callback_delete_cobbler);
    }

    // refresh accordion after get/add operations
    function refresh_accordion() {
        $('#accordion').accordion("refresh");
        // restore the status (open/close) of each section in accordion,
        // allow multiple section open at the same time
        accordion_status = status_object['{{object_type}}'];
        for (p in accordion_status) {
            if (accordion_status.hasOwnProperty(p) && accordion_status[p]) {
                $("#" + p).click();
                if (! accordion_status[p] ) {
                    $("#" + p).click();
                }
            }
        }
    }

    // callback func after add a new section
    function callback_add_cobbler(uid, data) {
        $add_h3 = $("#" + uid);
        $add_h3_div = $add_h3.next("div");
        $add_h3_div.remove();
        $add_h3.replaceWith(data["template"]);
        refresh_accordion();
    }

    // add button in add new object section (last section) of accordion
    function add_cobbler(cobbler_types, uid) {
        fill_cobbler_data(cobbler_add_fields, uid);
        console.log("ready to call add cobbler: " + JSON.stringify(cobbler_data));
        url = cobbler_url + "/" + cobbler_data['{{object_type}}']['name'];
        send_ajax_request(uid, url, "post", callback_add_cobbler);
        clear_cobbler_data();
    }

    // jquery ajax operation, call server asynchronously, support [get, post, put, delete]
    function send_ajax_request(uid, url, method, callback_func) {
        headers = {
                    Accept: "application/json",
                    "Content-Type": "application/json; charset=utf-8",
                  };
        if (method == "get") {
            $.ajax({
                type: "get",
                headers: headers,
                url: url,
                dataType: 'json',
                success: function(data) {
                    callback_func(uid, data);
                }
            });
        }
        else {
            $.ajax({
                type: method,
                headers: headers,
                url: url,
                dataType: 'json',
                data: JSON.stringify(cobbler_data),
                success: function(data) {
                    callback_func(uid, data);
                }
            });
        }
    }

function process_cobbler_collection_data(action, coll_parent, coll_name, one_value) {
    if (action == "delete") {
        delete cobbler_data[coll_parent][coll_name][one_value["name"]];
    }
    else {
        cobbler_data[coll_parent][coll_name][one_value["name"]] = one_value;
    }
}

function init_collection(uid, name) {
    default_selected = $("#" + uid + "_" + name).val();
    console.log("uid: " + uid + ", name: " + name + " init ...");
    console.log(JSON.stringify(cobbler_data[uid][name]));
    fill_collection_gui_data(uid, name, default_selected);
}

function fill_collection_gui_data(uid, name, value_selected) {
    sub_uid = uid + "_" + name;
    if(value_selected != "New...") {
        data = cobbler_data[uid][name][value_selected];
    }
    for(p in data) {
        if(data.hasOwnProperty(p)) {
            if (value_selected == "New...") {
                $("#" + sub_uid + "_" + p).val("");
            }
            else {
                $("#" + sub_uid + "_" + p).val(data[p]);
            }
        }
    }
}

</script>

<div id="accordion">
    {% if result["result"] %}
        {% set cobblers = result["data"] %}
        {% for cobbler_object in cobblers %}
            {% set data = cobbler_object['data'] %}
            {% if flag_collection %}
                {{CMB.CM_ACCORDION_PANEL_COLLECTION(object_type, data, filter, buttons, filter_collection)}}
            {% else %}
                {{CMB.CM_ACCORDION_PANEL(object_type, data, filter, buttons)}}
            {% endif %}
        {% endfor %}
        {% if flag_collection %}
            {{CMB.CM_ACCORDION_PANEL_COLLECTION(object_type, add_data["data"], add_data["filter"], add_data["button"], filter_collection, True)}}
        {% else %}
            {{CMB.CM_ACCORDION_PANEL(object_type, add_data["data"], add_data["filter"], add_data["button"], True)}}
        {% endif %}

    {% else %}
        <h3 id="error">"Error. Click for details."</h3>
        <div>
            <table>
                <tr>
                    <td>Error Description</td>
                    <td>{{result["description"]}}</td>
                </tr>
            </table>
        </div>
    {% endif %}
</div>
{% endblock %}