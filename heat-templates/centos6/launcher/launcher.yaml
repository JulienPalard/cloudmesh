heat_template_version: 2014-10-15

description: Cloudmesh Launcher with OpenStack Heat

parameters:
  Cookbook:
    type: string
    description: Cookbook name to use
  KeyName:
    type: string
    description: Key name for logging in to instance
  PasswdHash:
    type: string
    description: Password for IPython

resources:

  floating_ip:
    type: AWS::EC2::EIP
    properties:
      InstanceId: { get_resource: server }

  server:
    type: OS::Nova::Server
    properties:
      key_name: { get_param: KeyName }
      image: "futuregrid/centos-6"
      flavor: "m1.small"
      security_groups: [ "default" ]
      user_data:
        str_replace:
          template: |
            #!/bin/sh
            rpm -Uvh http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-2.noarch.rpm
            yum -y install git
            rpm -Uvh https://opscode-omnibus-packages.s3.amazonaws.com/el/6/x86_64/chef-11.4.0-1.el6.x86_64.rpm

            mkdir -p /var/chef
            mkdir -p /etc/chef

            git clone https://github.com/cloudmesh/chef.git /var/chef/cloudmesh-chef

            cat << EOL > /etc/chef/solo.rb
            log_location       STDOUT
            file_cache_path    "/var/chef"
            cookbook_path      [ "/var/chef/cloudmesh-chef/cookbooks" ]
            role_path          [ "/var/chef/cloudmesh-chef/roles" ]
            Mixlib::Log::Formatter.show_time = true
            EOL

            cat << EOL > /etc/chef/run_list.json
            { "run_list": ["role[$Cookbook]"], "ipython": { "notebook_password": "$PasswdHash" } }
            EOL

            chef-solo -j /etc/chef/run_list.json
          params:
            $Cookbook: { get_param: Cookbook }
            $PasswdHash: { get_param: PasswdHash }
